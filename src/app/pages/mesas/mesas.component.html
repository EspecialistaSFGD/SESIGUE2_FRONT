<app-page-header [title]="title.toUpperCase()" backUrl="panel" />
<div class="grid grid-cols-1">
  <nz-table [nzScroll]="{ x: 'max-content' }" class="min-w-full" [nzTitle]="HeaderMesas" nzShowSizeChanger nzSize="small"
    [nzData]="mesas()" [nzFrontPagination]="false" [nzLoading]="loading" [nzTotal]="pagination.total!"
    [nzPageSize]="pagination.pageSize!" [nzPageIndex]="pagination.currentPage!" (nzQueryParams)="onQueryParamsChange($event)">
    <thead>
      <tr>
        <th nzWidth="160px" nzAlign="center" nzColumnKey="estadoRegistro" [nzSortFn]="true">Estado</th>
        <th nzWidth="100px" nzAlign="center" nzColumnKey="codigo" [nzSortFn]="true">Codigo</th>
        <th>Mesa</th>
        <th nzWidth="120px" nzAlign="center" nzColumnKey="sectorId" [nzSortFn]="true">Sector</th>
        <th nzWidth="200px" nzAlign="center" nzColumnKey="secretariaTecnicaId" [nzSortFn]="true">Secretaría Técnica</th>
        <th nzWidth="100px" nzAlign="center">Fecha de Creación</th>
        <th nzWidth="100px" nzAlign="center">Fecha de Vigencia</th>
        <th nzWidth="80px" nzAlign="center">Resolución</th>
        <th nzWidth="80px" nzAlign="center">Sesión</th>
        <th nzWidth="80px" nzAlign="center">AM</th>
        <th nzRight nzWidth="120px" *ngIf="mesasActions.view || mesasActions.comment" nzAlign="center"></th>
      </tr>
    </thead>
    
    <tbody>
      @for(mesa of mesas(); track $index){
        <tr>
          <td nzAlign="center">
            <app-estado-tag [estado]="mesa.estadoRegistroNombre!"  class="w-full flex justify-center" />
          </td>
          <td nzAlign="center">
            <a [routerLink]="['/mesas', mesa.mesaId]" class="font-bold" nz-tooltip [nzTooltipTitle]="permisosPCM ? mesa.resumen : null">
              {{mesa.codigo}}
            </a>
          </td>
          <td><a [routerLink]="['/mesas', mesa.mesaId]" nz-tooltip [nzTooltipTitle]="permisosPCM ? mesa.alerta : null" nzTooltipColor="#b91c1c">{{mesa.nombre}}</a></td>
          <td nzAlign="center">{{mesa.sector}}</td>
          <td nzAlign="center">{{mesa.secretariaTecnica}}</td>
          <td nzAlign="center">{{mesa.fechaCreacion}}</td>
          <td nzAlign="center">{{mesa.fechaVigencia}}</td>
          <td nzAlign="center">
            <app-boton-descargar *ngIf="mesa.resolucion" [rutaArchivo]="mesa.resolucion" [titulo]="'Descargar resolución de creación'" />
          </td>
          <td nzAlign="center">
            @if(mesa.sesion){
              <app-boton-descargar [rutaArchivo]="mesa.sesion" [titulo]="'Descargar ultima sesión'"></app-boton-descargar>
            }
          </td>
          <td nzAlign="center">
            @if(mesa.am){
              <app-boton-descargar [rutaArchivo]="mesa.am" [titulo]="'Descargar ultima AM'"></app-boton-descargar>
            }
          </td>
          <td nzRight *ngIf="mesasActions.view || mesasActions.comment" nzAlign="center">
              <div class="flex justify-center">
                <a [routerLink]="[mesa.mesaId]" class="py-1 px-2 text-sky-700 hover:text-sky-800" nz-tooltip nzTooltipTitle="Ver detalle">
                  <i class="pi pi-eye" style="font-size: .85rem;"></i>
                </a>

                <app-boton icono="comments" [link]="true" tooltip="Agregar estado resumen" (click)="crearEstadoResumen(mesa, false)"/>

                <app-boton icono="comments" [color]="'red'" [stepColor]="500" [link]="true" tooltip="Agregar alerta" (click)="crearEstadoResumen(mesa, true)"/>
              </div>
          </td>
        </tr>
        }
    </tbody>
  </nz-table>
  
  <ng-template #HeaderMesas>
    <div class="ant-table-header flex flex-col sm:flex-row justify-between items-center">
      <p class="mb-2 sm:mb-0">Resultados {{pagination.total}}</p>
      <div class="flex gap-2">
        <app-boton *ngIf="mesasActions.report" [icono]="'filter'" [texto]="'Filtro'" [outline]="true" (click)="openFilters = true"/>

        <div *ngIf="mesasActions.report" class="flex items-center gap-1 py-1 px-3 gap-2 rounded border cursor-default border-sky-700 text-sky-700" nz-dropdown [nzDropdownMenu]="menu">
          Exportar
          <i class="pi pi-angle-down"></i>
        </div>
        <nz-dropdown-menu #menu="nzDropdownMenu">
            <div nz-menu class="p-0">
              <div nz-menu-item class="flex items-center px-3 py-2 gap-2 text-slate-700 hover:bg-sky-100 hover:text-sky-800" (click)="reporteMesas()">
                <i class="pi pi-file-excel"></i>
                Exportar Mesas
              </div>
              <div nz-menu-item class="flex items-center px-3 py-2 gap-2 text-slate-700 hover:bg-sky-100 hover:text-sky-800" (click)="reporteIntervencion()">
                <i class="pi pi-file-excel"></i>
                Exportar intervenciones
              </div>
            </div>
        </nz-dropdown-menu>

        <app-boton *ngIf="mesasActions.new" [icono]="'plus'" [texto]="'Nueva mesa'" (click)="crearMesa()"/>
      </div>
    </div>
  </ng-template>
</div>

<app-filtro-mesas *ngIf="openFilters" [visible]="openFilters" [pagination]="pagination" (visibleDrawer)="changeVisibleDrawer($event)" (filters)="generateFilters($event)" (export)="reporteMesas()" (save)="saveFilters($event)" />


