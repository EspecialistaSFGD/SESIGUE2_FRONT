<nz-page-header nzBackIcon [nzGhost]="false" (nzBack)="onBack()">
	<nz-page-header-title>{{title}}</nz-page-header-title>
</nz-page-header>

@if(mesa().mesaId){
	<app-mesa-detalle [mesa]="mesa()" [action]="false"/>
}

<div class="grid grid-cols-1">
	<nz-table #basicTable [nzScroll]="{ x: 'max-content' }" class="min-w-full" [nzTitle]="headerUbigeos" [nzData]="intervencionesEspacios()"
	[nzFrontPagination]="false" [nzShowPagination]="pagination.total! > 10"
	[nzLoading]="loading" [nzTotal]="pagination.total!" [nzPageSize]="pagination.pageSize!"
	[nzPageIndex]="pagination.currentPage!" (nzQueryParams)="onQueryParamsChange($event)">
		<thead>
			<tr>
				<th nzAlign="center" nzWidth="80px">Sector</th>
				<th nzAlign="center" nzWidth="120px">Ubicaci贸n</th>
				<th nzAlign="center" nzWidth="120px" nzColumnKey="e.entidad" [nzSortFn]="true">Entidad</th>
				<!-- <th nzAlign="center" nzWidth="100px">Tipo</th> -->
				<th nzAlign="center" nzWidth="100px">Subtipo</th>
				<th nzAlign="center" nzWidth="80px">Codigo</th>
				<th nzAlign="center" nzWidth="350px">Nombre</th>
				<th nzAlign="center" nzWidth="80px">Fecha SSI</th>
				<th nzAlign="center" nzWidth="100px">Costo Act.</th>
				<th nzAlign="center" nzWidth="100px">Dev Acum</th>
				<th nzAlign="center" nzWidth="100px">PIM</th>
				<th nzAlign="center" nzWidth="100px">DEV</th>
				<th nzAlign="center" nzWidth="250px" nzColumnKey="inicioIntervencionHitoId" [nzSortFn]="true">Hito Inicial</th>
				<th *ngIf="mesasAgendaActions.view || mesasAgendaActions.comment || mesasAgendaActions.delete" nzRight nzWidth="100px" nzAlign="center">Situaci贸n</th>
			</tr>
		</thead>
		<tbody>
			@for(intervencionEspacio of intervencionesEspacios(); track $index){
				<tr>
				  <td nzAlign="center">{{intervencionEspacio.sector}}</td>
				  <td nzAlign="center">
					{{intervencionEspacio.departamento}}
					{{intervencionEspacio.provincia ? ' / ' + intervencionEspacio.provincia  : '' }}
					{{intervencionEspacio.distrito ? ' / ' + intervencionEspacio.distrito  : '' }}
					</td>
				  <td nzAlign="center">{{intervencionEspacio.entidadTipo}} {{intervencionEspacio.entidadSlug}}</td>
				  <!-- <td nzAlign="center">{{intervencionEspacio.tipo | uppercase }}</td> -->
				  <td nzAlign="center">{{intervencionEspacio.subTipo | uppercase }}</td>
				  <td nzAlign="center">{{intervencionEspacio.codigoIntervencion}}</td>
				  <td nzAlign="center">{{intervencionEspacio.nombreIntervencion}}</td>
				  <td nzAlign="center" class="font-bold">{{intervencionEspacio.fechaSsi}}</td>
				  <td nzAlign="center">{{intervencionEspacio.costoActualizado! | numero : 0}}</td>
				  <td nzAlign="center">{{intervencionEspacio.devAcumulado! | numero : 0}}</td>
				  <td nzAlign="center">{{intervencionEspacio.pim! | numero : 0}}</td>
				  <td nzAlign="center">{{intervencionEspacio.devengado! | numero : 0}}</td>
				  <td nzAlign="center" nz-tooltip [nzTooltipTitle]=" mesasAgendaActions.comment ? intervencionEspacio.resumen : null">
					{{intervencionEspacio.inicioIntervencionFase}} <br> {{intervencionEspacio.inicioIntervencionEtapa}} <br> {{intervencionEspacio.inicioIntervencionHito}}
					</td>
				  <td nzRight nzAlign="center">
					<div class="flex justify-center">
						<app-boton *ngIf="mesasAgendaActions.comment" [link]="true" [icono]="'comments'" [tooltip]="'Agregar resumen'" (click)="comentarIntervencion(intervencionEspacio)"/>

						<app-boton *ngIf="mesasAgendaActions.view" [link]="true" [icono]="'eye'" [tooltip]="'Ver intervenci贸n'" (click)="intervencionDetalle(intervencionEspacio.intervencionEspacioId!)"/>

						<app-boton *ngIf="mesasAgendaActions.delete" [link]="true" [icono]="'trash'" [color]="'red'" [stepColor]="500" [disabled]="estadoEliminarIntervencionEspacio(intervencionEspacio)" [tooltip]="!estadoEliminarIntervencionEspacio(intervencionEspacio) ? 'Eliminar intervenci贸n' : ''"  (click)="!estadoEliminarIntervencionEspacio(intervencionEspacio) ? eliminarIntervencion(intervencionEspacio) : null"/>
					</div>
				  </td>
				<tr>
			}
		</tbody>
	</nz-table>
</div>

<ng-template #headerUbigeos>
	<div class="ant-table-header flex flex-col md:flex-row justify-between items-center">
		<div class="flex gap-4">
			<div class="mb-2 sm:mb-0">Resultados {{pagination.total}}</div>
			<div *ngIf="fechaSincronizacion" >Fecha de sincronizacion: {{fechaSincronizacion}}</div>
		</div>

		<div class="flex flex-col md:flex-row gap-2">
			<!-- <div class="flex gap-1 py-1 px-8 border rounded cursor-pointer bg-red-700 border-red-700 text-white hover:bg-red-900">
				<i class="pi pi-sync"></i>
				Procesar
			</div> -->
			<app-boton *ngIf="mesasAgendaActions.new && permisosPCM" [icono]="'sync'" [color]="'red'" [stepColor]="700" [texto]="'Procesar'"  (click)="procesarIntervencion()"/>

			<app-boton *ngIf="mesasAgendaActions.report" [icono]="'filter'" [texto]="'Filtro'" [outline]="true" (click)="openFilters = true"/>

			<app-boton *ngIf="mesasAgendaActions.report" [icono]="'file-excel'" tooltip="{{'Exportar intervenciones de la mesa: ' + mesa().abreviatura}}" [texto]="loadingExport ? 'Exportando...' : 'Exportar'" [loading]="loadingExport" [outline]="true" (click)="reporteIntervencion()"/>

			<app-boton *ngIf="mesasAgendaActions.new" [icono]="'plus'" tooltip="Nueva intervencion" [texto]="'Nueva Intervencion'"  (click)="crearIntervencion()"/>
		</div>
	  </div>
</ng-template>

<app-filtro-intervenciones *ngIf="openFilters" [visible]="openFilters" [esAcuerdo]="false" [esMesa]="true" [pagination]="pagination" (visibleDrawer)="this.openFilters = false" (filters)="generateFilters($event)" />
